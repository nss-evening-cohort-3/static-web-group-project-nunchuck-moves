YUI.add("search-photos-route",function(e,t){function r(e){r.superclass.constructor.call(this,e)}var n=require("lib/flog")(t);e.Routes[this.name]=r,e.extend(r,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t){var r={},i=this,s,o=!0,u=!0,a,f,l,c={};r.apiParams=this.processRequest(t),r.viewerNsid=t.probableUser||this.appContext.getViewer().nsid,s=r.apiParams[e.SearchHelper.API.text]||r.apiParams[e.SearchHelper.API.tags],!s&&!this.appContext.flipper.isFlipped("enable-slender-advanced-search")&&(o=!1),r.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.albums]&&r.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]&&(u=!1,o=!1);switch(r.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.viewType]){case"thumbs":a=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.thumbs;break;case"tiles":a=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.tiles;break;case"justified":a=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.justified}return l=this.generateUnifiedSubviewParams(r),l.everyone&&(c.everyone=this.appContext.getModel("search-photos-lite-models",l.everyone.id,l.everyone.fetchParams)),l.yours&&(c.yours=this.appContext.getModel("search-photos-lite-models",l.yours.id,l.yours.fetchParams)),l.contacts&&(c.contacts=this.appContext.getModel("search-photos-lite-models",l.contacts.id,l.contacts.fetchParams)),l.albums&&(c.albums=this.appContext.getModel("search-sets-models",l.albums.id,l.albums.fetchParams)),!a&&r.viewerNsid&&(c.viewerPrefs=this.appContext.getModel("person-preferences-models",r.viewerNsid)),f=t.query&&parseFloat(t.query.row_height)||1,f=Math.max(.5,Math.min(4,f)),e.FlickrPromise(c).then(function(t){a||(t.viewerPrefs?a=t.viewerPrefs.getValue("unifiedSearchViewPref"):a=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPE_DEFAULT),i.appContext.flipper.isFlipped("search-tiles")||a===e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPES.tiles&&(a=e.Models["person-preferences-models"].UNIFIED_SEARCH_VIEW_TYPE_DEFAULT);var n=r.apiParams[e.SearchHelper.API.text]||r.apiParams[e.SearchHelper.API.tags],s=i.intlMessage({intlName:"search.SEARCH"});return n!==undefined&&(s+=": "+n),e.Promise.resolve({view:"search-photos-unified-page-view",params:{unifiedSubviewParams:l,searchType:e.SearchUrl.searchTypes.PHOTOS,searchTerm:n,modelParams:r,showTools:o,showAdvanced:u,showSort:o,viewType:a,rowHeightMod:f},layout:"scrolling",fluid:!0,title:s})},function(t){n.error({err:t});var s=r.apiParams[e.SearchHelper.API.text]||r.apiParams[e.SearchHelper.API.tags],o=i.intlMessage({intlName:"search.SEARCH"});return s!==undefined&&(o+=": "+s),e.Promise.resolve({view:"search-photos-unified-page-view",params:{searchTerm:s,apiFailed:!0,modelParams:r},fluid:!0,title:o})})},generateUnifiedSubviewParams:function(t){var n={},r=t.apiParams,i;return e.SearchHelper.isParameterlessSearch(r)?n:(this.shouldPerformEveryoneSearch(t,r)&&(i=new e.SearchUrl(r,this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.everyone={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:25}}),this.shouldPerformYoursSearch(t,r)&&(i=new e.SearchUrl(e.merge({user_id:t.viewerNsid,sort:e.SearchHelper.API_SORT_OPTIONS.dateTaken},r),this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.yours={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:20}}),this.shouldPerformContactsSearch(t,r)&&(i=new e.SearchUrl(e.merge(r,{contacts:"all"}),this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.contacts={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:20}}),this.shouldPerformAlbumsSearch(t,r)&&(i=new e.SearchUrl(e.merge(r,{user_id:t.viewerNsid}),this.appContext,e.SearchUrl.searchTypes.PHOTOS),n.albums={id:i.getId(),fetchParams:{apiParams:i.getAPIParams(),perPage:20}}),n)},shouldPerformEveryoneSearch:function(t,n){return!n[e.SearchHelper.UNIFIED_STATE_PARAMS.albums]||!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},shouldPerformYoursSearch:function(t,n){return t.viewerNsid&&!n[e.SearchHelper.API.userId]&&!n[e.SearchHelper.API.groupId]&&!n[e.SearchHelper.API.contacts]&&!n[e.SearchHelper.API.faves]&&!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},shouldPerformContactsSearch:function(t,n){return t.viewerNsid&&!n[e.SearchHelper.API.userId]&&!n[e.SearchHelper.API.groupId]&&!n[e.SearchHelper.API.contacts]&&!n[e.SearchHelper.API.faves]&&!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},shouldPerformAlbumsSearch:function(t,n){return!t.viewerNsid||!n[e.SearchHelper.API.text]?!1:parseInt(n[e.SearchHelper.API.marketplace])?!1:n[e.SearchHelper.UNIFIED_STATE_PARAMS.albums]?!0:!n[e.SearchHelper.API.userId]&&!n[e.SearchHelper.API.groupId]&&!n[e.SearchHelper.API.contacts]&&!n[e.SearchHelper.API.faves]&&!n[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll]},processRequest:function(t){var n={};return n=e.merge(t.query,e.SearchHelper.mapRouteParamsToAPI(t.params)),n=e.SearchHelper.mapClassicSearchToAPI(n,this.appContext),e.SearchHelper.addParamDefaults(n),YUI.Env.isServer&&e.SearchHelper.unescapeParameters(n),n}}),e.mix(r.prototype,e.Localizable)},"@VERSION@",{requires:["flog","flickr-route","flickr-promise","search-helper","localizable","search-photos-lite-models","search-sets-models","url","search-url","search-photos-unified-page-view","person-preferences-models"],langBundles:["search"]});
