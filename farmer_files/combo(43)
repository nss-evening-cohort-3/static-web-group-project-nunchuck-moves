YUI.add("hermes-template-sub-photo-tags-tag-section",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function c(e,t){var r="",i,s;return r+='\n    <a href="#" class="show-add-tags">',s={hash:{intlName:"photo-page-scrappy.ADD_TAGS"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+"</a>\n",r}function h(e,t){var r="",i,s;return r+='\n	<a class="tag-section-header" href="',(i=n.tagPageURL)?i=i.call(e,{hash:{},data:t}):(i=e.tagPageURL,i=typeof i===f?i.apply(e):i),r+=a(i)+'">',s={hash:{intlName:"photo-page-scrappy.TAGS"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+"</a>\n",r}function p(e,t){var r="",i,s;return r+='\n	<h3 class="tag-section-header">',s={hash:{intlName:"photo-page-scrappy.TAGS"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+"</h3>\n",r}function d(e,t){var r="",i;r+='\n	<span class="label-beta">\n		',i=n["if"].call(e,e.displayAutotagsBetaLabel,{hash:{},inverse:l.program(10,m,t),fn:l.program(8,v,t),data:t});if(i||i===0)r+=i;return r+='\n	</span>\n	<span class="autotags-helper">\n		<i class="autotags-helper-icon"></i>\n	</span>\n',r}function v(e,t){var r="",i,s;return r+="\n			",s={hash:{intlName:"common.BETA"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+"\n		",r}function m(e,t){var r="",i,s;return r+="\n			",s={hash:{intlName:"common.ALPHA"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+"\n		",r}function g(e,t){var r="",i,s;return r+='\n    <input type="text" class= "add-tag" placeholder="',s={hash:{intlName:"photo-page-scrappy.ADD_A_TAG"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+'">\n',r}function y(e,t,r){var i="",s,o,c;i+='\n    <li data-author="',(s=n.tagAuthorNSID)?s=s.call(e,{hash:{},data:t}):(s=e.tagAuthorNSID,s=typeof s===f?s.apply(e):s),i+=a(s)+'" data-tag-id="',(s=n.id)?s=s.call(e,{hash:{},data:t}):(s=e.id,s=typeof s===f?s.apply(e):s),i+=a(s)+'" class="tag ',c={hash:{},inverse:l.noop,fn:l.program(15,b,t),data:t},o=(s=n.canRemoveTag||e.canRemoveTag,s?s.call(e,e.tagAuthorNSID,r.viewerNSID,r.isOwner,c):u.call(e,"canRemoveTag",e.tagAuthorNSID,r.viewerNSID,r.isOwner,c));if(o||o===0)i+=o;i+='" ',o=n["if"].call(e,r.autotagsEnabled,{hash:{},inverse:l.noop,fn:l.program(17,w,t),data:t});if(o||o===0)i+=o;i+='>\n	    <a class="',o=n["if"].call(e,r.autotagsEnabled,{hash:{},inverse:l.program(23,T,t),fn:l.program(20,S,t),data:t});if(o||o===0)i+=o;i+='" href="#">\n			<i class="',o=n["if"].call(e,r.autotagsEnabled,{hash:{},inverse:l.program(28,k,t),fn:l.program(25,N,t),data:t});if(o||o===0)i+=o;i+='" title="',c={hash:{intlName:"common.DELETE"},data:t},i+=a((s=n.intlMessage||r.intlMessage,s?s.call(e,c):u.call(e,"intlMessage",c)))+'"></i>\n	    </a>\n	    <a href="',o=n["if"].call(e,r.linkTagToTagsPage,{hash:{},inverse:l.program(32,A,t),fn:l.program(30,L,t),data:t});if(o||o===0)i+=o;return i+='" title="',(o=n.tagRaw)?o=o.call(e,{hash:{},data:t}):(o=e.tagRaw,o=typeof o===f?o.apply(e):o),i+=a(o)+'">',(o=n.tagRaw)?o=o.call(e,{hash:{},data:t}):(o=e.tagRaw,o=typeof o===f?o.apply(e):o),i+=a(o)+"</a>\n    </li>\n",i}function b(e,t){return"can-remove-tag"}function w(e,t){var r;return r=n["if"].call(e,e.duplicateAutotagId,{hash:{},inverse:l.noop,fn:l.program(18,E,t),data:t}),r||r===0?r:""}function E(e,t){var r="",i;return r+='data-autotag-id="',(i=n.duplicateAutotagId)?i=i.call(e,{hash:{},data:t}):(i=e.duplicateAutotagId,i=typeof i===f?i.apply(e):i),r+=a(i)+'"',r}function S(e,t){var r;return r=n["if"].call(e,e.duplicateAutotagId,{hash:{},inverse:l.program(23,T,t),fn:l.program(21,x,t),data:t}),r||r===0?r:""}function x(e,t){return"remove-dual-tag"}function T(e,t){return"remove-tag"}function N(e,t){var r;return r=n["if"].call(e,e.duplicateAutotagId,{hash:{},inverse:l.program(28,k,t),fn:l.program(26,C,t),data:t}),r||r===0?r:""}function C(e,t){return"delete-dual-tag"}function k(e,t){return"delete-tag"}function L(e,t){var r;return(r=n.url)?r=r.call(e,{hash:{},data:t}):(r=e.url,r=typeof r===f?r.apply(e):r),a(r)}function A(e,t){var r;return(r=n.searchUrl)?r=r.call(e,{hash:{},data:t}):(r=e.searchUrl,r=typeof r===f?r.apply(e):r),a(r)}function O(e,t,r){var i="",s;i+="\n",s=n.each.call(e,e.autotags,{hash:{},inverse:l.noop,fn:l.programWithDepth(35,M,t,e,r),data:t});if(s||s===0)i+=s;return i+="\n",i}function M(e,t,r,i){var s="",o;s+="\n	",o=n["if"].call(e,e.isPrivate,{hash:{},inverse:l.programWithDepth(41,H,t,r),fn:l.programWithDepth(36,_,t,r,i),data:t});if(o||o===0)s+=o;return s+="\n",s}function _(e,t,r,i){var s="",o,u;s+='\n		<li class="autotag private ',o=n["if"].call(e,i.viewerIsOwner,{hash:{},inverse:l.noop,fn:l.program(15,b,t),data:t});if(o||o===0)s+=o;s+='" data-autotag-content="',(o=n.autotagValue)?o=o.call(e,{hash:{},data:t}):(o=e.autotagValue,o=typeof o===f?o.apply(e):o),s+=a(o)+'" data-autotag-id="',(o=n.id)?o=o.call(e,{hash:{},data:t}):(o=e.id,o=typeof o===f?o.apply(e):o),s+=a(o)+'">\n			',o=n["if"].call(e,i.viewerIsOwner,{hash:{},inverse:l.noop,fn:l.program(37,D,t),data:t});if(o||o===0)s+=o;s+='\n			<span class="private-autotag">\n				<i class="private-autotag-icon" title="'+a((o=i.privateAutotagHelperText,typeof o===f?o.apply(e):o))+'"></i>\n			</span>\n			<a href="',u=n["if"].call(e,r.linkTagToTagsPage,{hash:{},inverse:l.program(32,A,t),fn:l.programWithDepth(39,P,t,r),data:t});if(u||u===0)s+=u;return s+='" title="',(u=n.autotagValue)?u=u.call(e,{hash:{},data:t}):(u=e.autotagValue,u=typeof u===f?u.apply(e):u),s+=a(u)+'">',(u=n.autotagValue)?u=u.call(e,{hash:{},data:t}):(u=e.autotagValue,u=typeof u===f?u.apply(e):u),s+=a(u)+"</a>\n		</li>\n	",s}function D(e,t){var r="",i,s;return r+='\n				<span class="remove-autotag">\n					<i class="delete-autotag" title="',s={hash:{intlName:"common.DELETE"},data:t},r+=a((i=n.intlMessage||e.intlMessage,i?i.call(e,s):u.call(e,"intlMessage",s)))+'"></i>\n				</span>\n			',r}function P(e,t,r){var i=""
,s,o;return i+=a((s=r.tagPageURL,typeof s===f?s.apply(e):s)),(o=n.autotagValue)?o=o.call(e,{hash:{},data:t}):(o=e.autotagValue,o=typeof o===f?o.apply(e):o),i+=a(o),i}function H(e,t,r){var i="",s;i+='\n		<li class="autotag ',s=n["if"].call(e,r.viewerIsOwner,{hash:{},inverse:l.noop,fn:l.program(15,b,t),data:t});if(s||s===0)i+=s;i+='" data-autotag-content="',(s=n.autotagValue)?s=s.call(e,{hash:{},data:t}):(s=e.autotagValue,s=typeof s===f?s.apply(e):s),i+=a(s)+'" data-autotag-id="',(s=n.id)?s=s.call(e,{hash:{},data:t}):(s=e.id,s=typeof s===f?s.apply(e):s),i+=a(s)+'">\n			',s=n["if"].call(e,r.viewerIsOwner,{hash:{},inverse:l.noop,fn:l.program(37,D,t),data:t});if(s||s===0)i+=s;i+='\n			<a href="',s=n["if"].call(e,r.linkTagToTagsPage,{hash:{},inverse:l.program(32,A,t),fn:l.programWithDepth(39,P,t,r),data:t});if(s||s===0)i+=s;return i+='" title="',(s=n.autotagValue)?s=s.call(e,{hash:{},data:t}):(s=e.autotagValue,s=typeof s===f?s.apply(e):s),i+=a(s)+'">',(s=n.autotagValue)?s=s.call(e,{hash:{},data:t}):(s=e.autotagValue,s=typeof s===f?s.apply(e):s),i+=a(s)+"</a>\n		</li>\n	",i}function B(e,t,r){var i="",s,o,c;i+='\n	    <li data-author="',(s=n.tagAuthorNSID)?s=s.call(e,{hash:{},data:t}):(s=e.tagAuthorNSID,s=typeof s===f?s.apply(e):s),i+=a(s)+'" data-tag-id="',(s=n.id)?s=s.call(e,{hash:{},data:t}):(s=e.id,s=typeof s===f?s.apply(e):s),i+=a(s)+'" class="tag ',c={hash:{},inverse:l.noop,fn:l.program(15,b,t),data:t},o=(s=n.canRemoveTag||e.canRemoveTag,s?s.call(e,e.tagAuthorNSID,r.viewerNSID,r.isOwner,c):u.call(e,"canRemoveTag",e.tagAuthorNSID,r.viewerNSID,r.isOwner,c));if(o||o===0)i+=o;i+='">\n		    <a class="remove-tag" href="#">\n		    	<i class="delete-tag" title="',c={hash:{intlName:"common.DELETE"},data:t},i+=a((s=n.intlMessage||e.intlMessage,s?s.call(e,c):u.call(e,"intlMessage",c)))+'"></i>\n		    </a>\n		    <a href="',o=n["if"].call(e,r.linkTagToTagsPage,{hash:{},inverse:l.program(32,A,t),fn:l.program(30,L,t),data:t});if(o||o===0)i+=o;return i+='" title="',(o=n.tagRaw)?o=o.call(e,{hash:{},data:t}):(o=e.tagRaw,o=typeof o===f?o.apply(e):o),i+=a(o)+'">',(o=n.tagRaw)?o=o.call(e,{hash:{},data:t}):(o=e.tagRaw,o=typeof o===f?o.apply(e):o),i+=a(o)+"</a>\n	    </li>\n    ",i}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u=n.helperMissing,a=this.escapeExpression,f="function",l=this;o=n["if"].call(t,t.canAddMeta,{hash:{},inverse:l.noop,fn:l.program(1,c,i),data:i});if(o||o===0)s+=o;s+="\n\n",o=n["if"].call(t,t.linkTagToTagsPage,{hash:{},inverse:l.program(5,p,i),fn:l.program(3,h,i),data:i});if(o||o===0)s+=o;s+="\n\n",o=n["if"].call(t,t.showTagInfoBlock,{hash:{},inverse:l.noop,fn:l.program(7,d,i),data:i});if(o||o===0)s+=o;s+='\n\n<ul class="tags-list">\n',o=n["if"].call(t,t.canAddMeta,{hash:{},inverse:l.noop,fn:l.program(12,g,i),data:i});if(o||o===0)s+=o;s+="\n",o=n.each.call(t,t.tags,{hash:{},inverse:l.noop,fn:l.programWithDepth(14,y,i,t),data:i});if(o||o===0)s+=o;s+="\n",o=n["if"].call(t,t.autotagsEnabled,{hash:{},inverse:l.noop,fn:l.programWithDepth(34,O,i,t),data:i});if(o||o===0)s+=o;s+='\n\n<div style="clear:both;"></div>\n</ul>\n\n<div style="clear:both;"></div>\n\n<div class="machine-tags-section">\n    <ul class="machine-tags-list">\n    ',o=n.each.call(t,t.machineTags,{hash:{},inverse:l.noop,fn:l.programWithDepth(43,B,i,t),data:i});if(o||o===0)s+=o;return s+='\n    </ul>\n\n    <div style="clear:both;"></div>\n</div>\n',s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/sub-photo-tags-tag-section",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-sub-photo-tags-tag",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function c(e,t){return'data-tag-might-exist="true"'}function h(e,t){return"remove-dual-tag"}function p(e,t){return"remove-tag"}function d(e,t){return"delete-dual-tag"}function v(e,t){return"delete-tag"}function m(e,t){var r="",i;return(i=n.tagPageURL)?i=i.call(e,{hash:{},data:t}):(i=e.tagPageURL,i=typeof i===u?i.apply(e):i),r+=a(i),(i=n.tagWithoutSlashes)?i=i.call(e,{hash:{},data:t}):(i=e.tagWithoutSlashes,i=typeof i===u?i.apply(e):i),r+=a(i),r}function g(e,t){var r,i;return i={hash:{},data:t},a((r=n.getTagSearchUrl||e.getTagSearchUrl,r?r.call(e,e.tagValue,i):f.call(e,"getTagSearchUrl",e.tagValue,i)))}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u="function",a=this.escapeExpression,f=n.helperMissing,l=this;s+='<li data-tag-id="',(o=n.escapedTagRaw)?o=o.call(t,{hash:{},data:i}):(o=t.escapedTagRaw,o=typeof o===u?o.apply(t):o),s+=a(o)+'" ',o=n["if"].call(t,t.mightExist,{hash:{},inverse:l.noop,fn:l.program(1,c,i),data:i});if(o||o===0)s+=o;s+=' class="tag" data-validated="false">\n    <a class="',o=n["if"].call(t,t.isDualTag,{hash:{},inverse:l.program(5,p,i),fn:l.program(3,h,i),data:i});if(o||o===0)s+=o;s+='" href="#">\n        <i class="',o=n["if"].call(t,t.isDualTag,{hash:{},inverse:l.program(9,v,i),fn:l.program(7,d,i),data:i});if(o||o===0)s+=o;s+='" title="Delete"></i>\n    </a>\n    <a href="',o=n["if"].call(t,t.linkTagToTagsPage,{hash:{},inverse:l.program(13,g,i),fn:l.program(11,m,i),data:i});if(o||o===0)s+=o;return s+='" title="',(o=n.tagRaw)?o=o.call(t,{hash:{},data:i}):(o=t.tagRaw,o=typeof o===u?o.apply(t):o),s+=a(o)+'">',(o=n.tagRaw)?o=o.call(t,{hash:{},data:i}):(o=t.tagRaw,o=typeof o===u?o.apply(t):o),s+=a(o)+"</a>\n</li>\n",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/sub-photo-tags-tag",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-tags-helper-text",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a=n.helperMissing,f=this.escapeExpression;return s+='<div class="tags-helper-text">\n	',u={hash:{intlName:"photo-page-scrappy.TAGS_HELP_TEXT"},data:i},s+=f((o=n.intlMessage||t.intlMessage,o?o.call(t,u):a.call(t,"intlMessage",u)))+'\n</div>\n<a href="//help.yahoo.com/kb/flickr/tag-keywords-flickr-sln7455.html" target="_blank">',u={hash:{intlName:"common.LEARN_MORE"},data:i},s+=f((o=n.intlMessage||t.intlMessage,o?o.call(t,u):a.call(t,"intlMessage",u)))+"</a>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/tags-helper-text",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("sub-photo-tags-tag-view",function(e){var t={tagHoverMaxWidth:23};e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){return this.photoId=t.photoId,this.context=e.clone(t.context,!0),this.nsid=t.nsid,this.pathAlias=t.pathAlias,this.isMobileTags=t.isMobileTags||!1,this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},loadState:function(){var t=this,n=new e.FlickrPromise({photo:t.appContext.getModel("photo-models",t.photoId),photoTags:t.appContext.getModel("photo-tags-models",this.photoId),tagModel:t.appContext.getModelRegistry("tag-models"),photoAutotags:t.appContext.getModel("photo-autotags-models",t.photoId),autotagModel:t.appContext.getModelRegistry("autotag-models")});return n.then(function(e){t.set("photo",e.photo),t.set("photoTags",e.photoTags),t.set("tagModel",e.tagModel),t.set("photoAutotags",e.photoAutotags),t.set("autotagModel",e.autotagModel)})},buildContainer:function(){var e=this,t,n=this.get("photo"),r=this.get("photoTags"),i=r.getValue("tags"),s=n.getValue("isOwner")||n.getValue("canAddMeta"),o=/^[a-zA-Z]\w*:[a-zA-Z]\w*=.+/,u=[],a=[],f,l=!1,c=!1,h=!1,p=this.get("photoAutotags"),d=p.getValue("autotags"),v=n.getValue("isOwner"),m=!1,g=this.appContext.flipper.isFlipped("enable-photopage-autotags-beta-label"),y=!this.isMobileTags,b=this.appContext.flipper.isFlipped("enable-tag-page-link-on-photo-page");if(i){i=i.toJSON();if(i.length!==0){l=!0;for(f=0;f<i.length;f++)o.test(i[f].tagRaw)?u.push(i[f]):a.push(i[f])}}d&&(d=d.toJSON(),d.length!==0&&(c=!0,v?m=e.intlMessage({intlName:"photo-page-scrappy.PRIVATE_TAGS_OWNER_HELPER_TEXT"}):m=e.intlMessage({intlName:"photo-page-scrappy.PRIVATE_TAGS_FRIENDS_FAMILY_HELPER_TEXT"}))),!l&&!c&&(h=!0),h&&s&&(this.get("container").addClass("empty"),this.fire("subviewViewEvent","tagsTagView:tagsEmpty"));if(s||!h)t=this.templates("sub-photo-tags-tag-section")({tags:a,machineTags:u,autotags:d,viewerIsOwner:v,privateAutotagHelperText:m,canAddMeta:n.getValue("isOwner")||n.getValue("canAddMeta"),viewerNSID:this.appContext.getViewer().nsid,isOwner:n.getValue("isOwner"),autotagsEnabled:!0,displayAutotagsBetaLabel:g,showTagInfoBlock:y,linkTagToTagsPage:b,tagPageURL:"/photos/tags/"});return this.setContainerHTML(t),this},activate:function(){var t=this.get("photo"),n=this.get("container"),r=t.getValue("owner")||t.getValue("canAddMeta"),i=this.get("photoTags"),s=i.getValue("tags"),o=/^[a-zA-Z]\w*:[a-zA-Z]\w*=.+/,u=[],a=n.one(".autotags-helper"),f=this,l,c=this.appContext.getViewer().prefs.keyboardShortcutsEnabled;s&&(s=s.toJSON()),s.length===0&&this.fire("subviewViewEvent","noTags");for(l=0;l<s.length;l++)o.test(s[l].tagRaw)&&u.push(s[l]);return u.length&&n.one(".machine-tags-section").setStyle("display","block"),!this.isMobileTags&&r&&n.one(".show-add-tags")&&(n.one(".show-add-tags").on("click",function(e){e.preventDefault(),n.hasClass("empty")&&(n.removeClass("empty"),f.fire("subviewViewEvent","tagsTagView:tagsNotEmpty")),n.one(".add-tag").setStyle("display","block"),n.one(".add-tag").focus()}),this.setupAddTagEvents(),this.setupRollOverTagEvents(),this.setupRemoveTagEvents(),this.registerEventHandler(e.on("flickr:photo-page--new-tags-added",function(){f.buildContainer(),f.setupRollOverTagEvents(),f.setupRemoveTagEvents()})),this.registerEventHandler(e.on("flickr:photo-page:focus_tag_entry",function(e){var t=f.get("container");t&&t.one(".tags-list .add-tag")&&t.one(".tags-list .add-tag").focus()})),c&&this.attachKeyEvent("down:84",function(e){e.preventDefault();try{n.hasClass("empty")&&(n.removeClass("empty"),f.fire("subviewViewEvent","tagsTagView:tagsNotEmpty")),n.one(".add-tag").setStyle("display","block"),n.one(".add-tag").focus()}catch(t){}})),!this.isMobileTags&&a&&this.registerEventHandler(a.on("click",function(e){f.showAutotagsHelper(e)},a)),this},setupAddTagEvents:function(){var e=this.get("container"),t="",n=this;this.registerEventHandler(e.one(".add-tag").on("keydown",function(e){e.charCode===13&&(e.preventDefault(),this.blur())})),this.registerEventHandler(e.one(".add-tag").on("blur",function(){var r=this,i=r.get("value");if(i===t)return;r.set("value",""),i.length===0&&(i='""'),i.trim()!=='""'&&i.trim()!==t?(e.one(".tags-list").all(".end-of-the-line").removeClass("end-of-the-line"),e.one(".tags-list").all(".not-eol").removeClass("not-eol"),e.one(".machine-tags-section").getStyle("display")==="block"&&(e.one(".machine-tags-list").all(".end-of-the-line").removeClass("end-of-the-line"),e.one(".machine-tags-list").all(".not-eol").removeClass("not-eol")),n.saveTag(i),setTimeout(function(){r.focus()},4)):this.set("text",t)}))},_whichTagList:function(){var e=/^[a-zA-Z]\w*:[a-zA-Z]\w*=.+/,t=this.get("container"),n=[t.one(".machine-tags-list"),t.one(".tags-list")];return function(r){return e.test(r)?n[0]:n[1]}},saveTag:function(t){var n=this.get("container"),r=this.get("tagModel"),i=this.get("photoTags").getValue("tags"),s=this.get("photoAutotags").getValue("autotags"),o=!1,u=!1,a=this._whichTagList(),f,l=this,c;c=this.processTag(t),f=c.map(function(e){return e.toLowerCase()}),o=i.getList().some(function(e){return f.indexOf(e.getValue("tagValue").toLowerCase())!==-1}),u=s.getList().some(function(e){return f.indexOf(e.getValue("autotagValue").toLowerCase())!==-1}),r.remoteCreate({photoId:[l.photoId],tags:[t]}).then(function(t){t.forEach(function(e){var t=e.getValue("tagRaw"),n=e.getValue("duplicateAutotagId"),r=a(t),i=r.one("[data-tag-id='"+escape(t)+"']"),s;i.setAttribute("data-tag-id",e.getValue("id")),i.setAttribute("data-validated","true"),i.setAttribute("data-tag-might-exist","false"),i.setAttribute("data-author",e.getValue("tagAuthorNSID")),i.addClass("can-remove-tag"),n&&(s=r.one("[data-autotag-content='"+t+"']"),i.setAttribute("data-autotag-id",e.getValue("duplicateAutotagId")),s.remove(!0))}),e.all("[data-tag-might-exist='true']").set("text",l.intlMessage({intlName:"photo-page-scrappy.DUPLICATE_TAG"})).setAttribute("data-validated","true").addClass("invalid-tag"),
e.all("[data-validated='false']").set("text",l.intlMessage({intlName:"photo-page-scrappy.INVALID_TAG"})).addClass("invalid-tag"),clearTimeout(l.invalidTagRemoval),l.invalidTagRemoval=setTimeout(function(){n.all(".invalid-tag").remove(!0)},4500)},function(e){var t;t=n.all("[data-validated='false']"),n.all(".autotag").removeClass("hidden"),t.size()&&t.remove(),e.code===2?l.onError(l.intlMessage({intlName:"photo-page-scrappy.MAX_TAG_LIMIT"})):l.onError(l.intlMessage({intlName:"photo-page-scrappy.ERROR_ADDING_TAG"}))}),c.forEach(function(e){var t=a(e).show(),r=t.hasClass("machine-tags-list"),i=l.appContext.flipper.isFlipped("enable-tag-page-link-on-photo-page"),s,f,c,h={tagValue:e.replace(/\s/g,""),tagRaw:e,escapedTagRaw:escape(e),mightExist:o,isDualTag:u,tagWithoutSlashes:e.replace(/\//g,""),linkTagToTagsPage:i,tagPageURL:"/photos/tags/"};r?(e.indexOf(" ")>0?(f=e.indexOf("=")+1,c=e.substring(0,f)+'"'+e.substring(f)+'"',h.tagValue=c):h.tagValue=e,n.one(".machine-tags-section").getStyle("display")==="none"&&n.one(".machine-tags-section").setStyle("display","block"),s=l.templates("sub-photo-tags-tag")(h),t.prepend(s)):(h.tagValue=e.replace(/\s/g,""),s=l.templates("sub-photo-tags-tag")(h),u&&t.one("[data-autotag-content='"+e+"']").addClass("hidden"),t.one(".add-tag").insert(s,"after"))}),l.setupRollOverTagEvents()},setupRemoveTagEvents:function(){var t=this.get("container"),n=this.get("photoTags"),r=n.getValue("tags"),i=this.get("tagModel"),s=this.get("photoAutotags"),o=s.getValue("autotags"),u=this.get("autotagModel"),a={},f=t.one(".machine-tags-list"),l=this;this.registerEventHandler(t.all(".tags-list, .machine-tags-list").on("click",function(n){if(n.target.hasClass("remove-tag")||n.target.hasClass("delete-tag")||n.target.hasClass("remove-autotag")||n.target.hasClass("delete-autotag")||n.target.hasClass("remove-dual-tag")||n.target.hasClass("delete-dual-tag")){n.preventDefault();var s=n.target.ancestor(".tag",!0),c,h;s?(c=s.getAttribute("data-tag-id"),i.remoteDelete(c).then(function(){r.removeFromList(c,"id"),s.remove(!0),r.toJSON().length===0&&o.toJSON().length===0?(t.addClass("empty"),l.fire("subviewViewEvent","tagsTagView:tagsEmpty")):r.toJSON().length===0&&t.one(".add-tag").setStyle("display","none")},function(){l.onError(l.intlMessage({intlName:"photo-page-scrappy.ERROR_DELETING_TAG"}))}),n.target.hasClass("remove-dual-tag")||n.target.hasClass("delete-dual-tag")?(h=s.getAttribute("data-autotag-id"),a.photo_id=l.photoId,a.autotags=h,u.remoteDelete(a).then(function(){o.remove(h,"id")},function(){e.Flog.info(l.name,"deleting the corresponding autotag for this usertag failed")}),e.rapidTracker.beacon(l.name,"dualTagDeleteClick",{type:h})):e.rapidTracker.beacon(l.name,"tagDeleteClick")):(s=n.target.ancestor(".autotag",!0),h=s.getAttribute("data-autotag-id"),a.photo_id=l.photoId,a.autotags=h,u.remoteDelete(a).then(function(){o.remove(h,"id"),s.remove(!0),o.toJSON().length===0&&r.toJSON().length===0&&(t.one(".add-tag").setStyle("display","none"),t.addClass("empty"),l.fire("subviewViewEvent","tagsTagView:tagsEmpty"))},function(){l.onError(l.intlMessage({intlName:"photo-page-scrappy.ERROR_DELETING_TAG"}))}),e.rapidTracker.beacon(l.name,"autotagDeleteClick",{type:h})),f.getDOMNode().childElementCount||t.one(".machine-tags-section").setStyle("display","none"),t.one(".tags-list").all(".end-of-the-line").removeClass("end-of-the-line"),t.one(".tags-list").all(".not-eol").removeClass("not-eol"),t.one(".machine-tags-section").getStyle("display")==="block"&&(t.one(".machine-tags-list").all(".end-of-the-line").removeClass("end-of-the-line"),t.one(".machine-tags-list").all(".not-eol").removeClass("not-eol"))}}))},processTag:function(t){var n,r,i;i=t.replace(/"(.*?)"/g,function(e,t){return t=t.replace(/(,)/g,function(e,t){return t="{COMMA}",t}),t=t.replace(/(\s+)/g,function(e,t){return t="{WHITESPACE"+t.charCodeAt(0)+"}",t}),t}),i.indexOf(",")>-1?r=i.split(/,/):r=i.split(/\s+/);for(n in r)r[n]=r[n].replace(/\{WHITESPACE([0-9]+)\}/g,function(e,t){return t=String.fromCharCode(t),t}),r[n]=r[n].replace(/\{COMMA\}/g,function(e,t){return t=",",t});return e.Array.each(r,function(t,n){t=e.Lang.trim(t),r[n]=t}),r=e.Array.filter(r,function(e,t){if(e.length>0)return!0}),r},setupRollOverTagEvents:function(){var e=this.get("container"),n;this.registerEventHandler(e.all(".tags-list, .machine-tags-list").on("mouseover",function(e){n=e.target.ancestor(".tag, .autotag",!0);if(n&&n.hasClass("can-remove-tag")){var r=n.ancestor(".tags-list")?n.ancestor(".tags-list").getDOMNode().offsetLeft:n.ancestor(".machine-tags-list").getDOMNode().offsetLeft,i=n.getDOMNode().offsetLeft,s=n.ancestor(".tags-list")?parseInt(n.ancestor(".tags-list").getComputedStyle("width"),10):parseInt(n.ancestor(".machine-tags-list").getComputedStyle("width"),10),o=parseInt(n.getComputedStyle("width"),10);s-(i-r+o)<=t.tagHoverMaxWidth?(n.removeClass("not-eol"),n.addClass("end-of-the-line")):(n.removeClass("end-of-the-line"),n.addClass("not-eol"))}}))},showAutotagsHelper:function(t){var n=this.get("container"),r=n.one(".autotags-helper-icon"),i,s=this.templates("tags-helper-text");i=new e.Views.FluidDroparound({appContext:this.appContext,dismissOnOverlayClick:!0,showDropArrow:!0,width:240,observePageResize:!0,anchorElement:r,htmlMessage:s({})}),i.show()},onError:function(t){return this.errorDialog=new e.Views.FluidModal({appContext:this.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,showCancelButton:!1,title:this.intlMessage({intlName:"common.OOPS"}),actionButtonLabel:this.intlMessage({intlName:"common.OK"}),message:t,darkOverlay:!0}),this.errorDialog.show(),this.errorDialog}})},"@VERSION@",{requires:["flog","flickr-view","dialog","hermes-template-sub-photo-tags-tag-section","hermes-template-sub-photo-tags-tag","hermes-template-tags-helper-text","sub-photo-tags-tag-section-css","hermes-template-head-meta","url-helper"],optional:[],langBundles:["common","photo-page-scrappy"]});
YUI.add("hermes-template-sub-photo-person-pro-badgeable",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function c(e,t){var n="",r;return n+="data-"+f((r=(r=e.dataAttr,r==null||r===!1?r:r.key),typeof r===a?r.apply(e):r))+'="'+f((r=(r=e.dataAttr,r==null||r===!1?r:r.value),typeof r===a?r.apply(e):r))+'"',n}function h(e,t){var n;return f((n=(n=e.buddyicon,n==null||n===!1?n:n["default"]),typeof n===a?n.apply(e):n))}function p(e,t){var r;return(r=n.buddyicon)?r=r.call(e,{hash:{},data:t}):(r=e.buddyicon,r=typeof r===a?r.apply(e):r),f(r)}function d(e,t){return'<a href="/account/upgrade/pro" class="pro-badge-inline">PRO</a>'}function v(e,t){return'\n		<a class="remove-person hide-text ui-icon-comment-delete" href="#">x</a>\n		'}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a="function",f=this.escapeExpression,l=this;s+='<li class="person" ',o=n["if"].call(t,t.dataAttr,{hash:{},inverse:l.noop,fn:l.program(1,c,i),data:i});if(o||o===0)s+=o;s+='>\n	<div class="person-icon">\n		<a class="',(o=n.extraClasses)?o=o.call(t,{hash:{},data:i}):(o=t.extraClasses,o=typeof o===a?o.apply(t):o),s+=f(o)+'" href="/photos/',(o=n.pathAlias)?o=o.call(t,{hash:{},data:i}):(o=t.pathAlias,o=typeof o===a?o.apply(t):o),s+=f(o)+'/" data-track="',(o=n.dataTrackPrefix)?o=o.call(t,{hash:{},data:i}):(o=t.dataTrackPrefix,o=typeof o===a?o.apply(t):o),s+=f(o)+'PersonIconClick">\n			<div class="circle-icon" data-person-nsid="',(o=n.nsid)?o=o.call(t,{hash:{},data:i}):(o=t.nsid,o=typeof o===a?o.apply(t):o),s+=f(o)+'">\n				<img class="show-person-menu" src="',u=n["if"].call(t,(o=t.buddyicon,o==null||o===!1?o:o["default"]),{hash:{},inverse:l.program(5,p,i),fn:l.program(3,h,i),data:i});if(u||u===0)s+=u;s+='" width="32" height="32">\n			</div>\n			<span class="person-name">',(u=n.displayname)?u=u.call(t,{hash:{},data:i}):(u=t.displayname,u=typeof u===a?u.apply(t):u),s+=f(u)+"</span>",u=n["if"].call(t,t.isPro,{hash:{},inverse:l.noop,fn:l.program(7,d,i),data:i});if(u||u===0)s+=u;s+="\n		</a>\n		",u=n["if"].call(t,t.showRemove,{hash:{},inverse:l.noop,fn:l.program(9,v,i),data:i});if(u||u===0)s+=u;return s+="\n	</div>\n</li>\n",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/sub-photo-person-pro-badgeable",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-sub-photo-person",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function c(e,t){var n="",r;return n+="data-"+f((r=(r=e.dataAttr,r==null||r===!1?r:r.key),typeof r===a?r.apply(e):r))+'="'+f((r=(r=e.dataAttr,r==null||r===!1?r:r.value),typeof r===a?r.apply(e):r))+'"',n}function h(e,t){var n;return f((n=(n=e.buddyicon,n==null||n===!1?n:n["default"]),typeof n===a?n.apply(e):n))}function p(e,t){var r;return(r=n.buddyicon)?r=r.call(e,{hash:{},data:t}):(r=e.buddyicon,r=typeof r===a?r.apply(e):r),f(r)}function d(e,t){return'\n		<a class="remove-person hide-text ui-icon-comment-delete" href="#">x</a>\n		'}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a="function",f=this.escapeExpression,l=this;s+='<li class="person" ',o=n["if"].call(t,t.dataAttr,{hash:{},inverse:l.noop,fn:l.program(1,c,i),data:i});if(o||o===0)s+=o;s+='>\n	<div class="person-icon">\n		<a class="',(o=n.extraClasses)?o=o.call(t,{hash:{},data:i}):(o=t.extraClasses,o=typeof o===a?o.apply(t):o),s+=f(o)+'" href="/photos/',(o=n.pathAlias)?o=o.call(t,{hash:{},data:i}):(o=t.pathAlias,o=typeof o===a?o.apply(t):o),s+=f(o)+'/" data-track="',(o=n.dataTrackPrefix)?o=o.call(t,{hash:{},data:i}):(o=t.dataTrackPrefix,o=typeof o===a?o.apply(t):o),s+=f(o)+'PersonIconClick">\n			<div class="circle-icon" data-person-nsid="',(o=n.nsid)?o=o.call(t,{hash:{},data:i}):(o=t.nsid,o=typeof o===a?o.apply(t):o),s+=f(o)+'">\n				<img class="show-person-menu" src="',u=n["if"].call(t,(o=t.buddyicon,o==null||o===!1?o:o["default"]),{hash:{},inverse:l.program(5,p,i),fn:l.program(3,h,i),data:i});if(u||u===0)s+=u;s+='" width="32" height="32">\n			</div>\n			<span class="person-name">\n				',(u=n.displayname)?u=u.call(t,{hash:{},data:i}):(u=t.displayname,u=typeof u===a?u.apply(t):u),s+=f(u)+"\n			</span>\n		</a>\n		",u=n["if"].call(t,t.showRemove,{hash:{},inverse:l.noop,fn:l.program(7,d,i),data:i});if(u||u===0)s+=u;return s+="\n	</div>\n</li>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/sub-photo-person",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-invite-person",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function l(e,t){var n="",r;return n+="data-"+a((r=(r=e.dataAttr,r==null||r===!1?r:r.key),typeof r===u?r.apply(e):r))+'="'+a((r=(r=e.dataAttr,r==null||r===!1?r:r.value),typeof r===u?r.apply(e):r))+'"',n}function c(e,t){return'\n		<a class="remove-person hide-text ui-icon-comment-delete" href="#">x</a>\n		'}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u="function",a=this.escapeExpression,f=this;s+='<li class="person" ',o=n["if"].call(t,t.dataAttr,{hash:{},inverse:f.noop,fn:f.program(1,l,i),data:i});if(o||o===0)s+=o;s+='>\n	<div class="person-icon">\n		<div class="circle-icon">\n			<img src="https://s.yimg.com/pw/images/icon_unread.gif" width="',(o=n.size)?o=o.call(t,{hash:{},data:i}):(o=t.size,o=typeof o===u?o.apply(t):o),s+=a(o)+'" height="',(o=n.size)?o=o.call(t,{hash:{},data:i}):(o=t.size,o=typeof o===u?o.apply(t):o),s+=a(o)+'">\n		</div>\n		<p class="person-name">\n		',(o=n.email)?o=o.call(t,{hash:{},data:i}):(o=t.email,o=typeof o===u?o.apply(t):o),s+=a(o)+"\n		</p>\n		",o=n["if"].call(t,t.showRemove,{hash:{},inverse:f.noop,fn:f.program(3,c,i),data:i});if(o||o===0)s+=o;return s+="\n	</div>\n</li>\n",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/invite-person",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-creatr-footer",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){return this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{},'<!-- creatr footer -->\n\n<div class="pure-g creatr-footer-wrapper">\n\n	<div class="pure-u-1-5">\n	</div>\n\n	<div class="pure-u-3-5">\n\n		<div class="legalese">\n\n			<a href="/ATOS/Create/" target="_blank">terms</a> | <a href="https://info.yahoo.com/privacy/us/yahoo/flickr/details.html" target="_blank">privacy</a> | <a href="https://help.yahoo.com/kb/index?page=content&y=PROD_FLICKR&locale=en_US&id=SLN22232" target="_blank">help</a>\n\n		</div>\n\n	</div>\n\n	<div class="pure-u-1-5">\n	</div>\n\n</div>\n'}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/creatr-footer",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-sub-photo-tags-people-section",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function h(e,t){var r="",i,s;return r+='\n    <a href="#" class="show-add-people">',s={hash:{intlName:"photo-page-scrappy.ADD_PEOPLE"},data:t},r+=l((i=n.intlMessage||e.intlMessage,i?i.call(e,s):f.call(e,"intlMessage",s)))+"</a>\n",r}function p(e,t){var r="",i,s;return r+='\n<input type ="text" class="add-person" placeholder="',s={hash:{intlName:"photo-page-scrappy.ADD_PERSON"},data:t},r+=l((i=n.intlMessage||e.intlMessage,i?i.call(e,s):f.call(e,"intlMessage",s)))+'">\n',r}function d(e,t){var r="",i;r+="\n\n	",i=n.each.call(e,e.people,{hash:{},inverse:c.noop,fn:c.program(6,v,t),data:t});if(i||i===0)r+=i;return r+="\n\n",r}function v(e,t){var r="",i;r+="\n		",i=n["if"].call(e,e.person,{hash:{},inverse:c.program(9,g,t),fn:c.program(7,m,t),data:t});if(i||i===0)r+=i;return r+="\n	",r}function m(e,t){var i="",s;i+="\n			",s=c.invokePartial(r["sub-photo-person-pro-badgeable"],"sub-photo-person-pro-badgeable",e.person,n,r,t);if(s||s===0)i+=s;return i+="\n		",i}function g(e,t){var i="",s;i+="\n			",s=c.invokePartial(r["invite-person"],"invite-person",e.invite,n,r,t);if(s||s===0)i+=s;return i+="\n		",i}function y(e,t){var r="",i;r+="\n\n	",i=n.each.call(e,e.people,{hash:{},inverse:c.noop,fn:c.program(12,b,t),data:t});if(i||i===0)r+=i;return r+="\n\n",r}function b(e,t){var r="",i;r+="\n		",i=n["if"].call(e,e.person,{hash:{},inverse:c.program(9,g,t),fn:c.program(13,w,t),data:t});if(i||i===0)r+=i;return r+="\n	",r}function w(e,t){var i="",s;i+="\n			",s=c.invokePartial(r["sub-photo-person"],"sub-photo-person",e.person,n,r,t);if(s||s===0)i+=s;return i+="\n		",i}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),r=this.merge(r,e.partials),i=i||{};var s="",o,u,a,f=n.helperMissing,l=this.escapeExpression,c=this;s+="<h3>",a={hash:{intlName:"photo-page-scrappy.PEOPLE_IN_PHOTO"},data:i},s+=l((o=n.intlMessage||t.intlMessage,o?o.call(t,a):f.call(t,"intlMessage",a)))+"</h3>\n\n",u=n["if"].call(t,t.canAddMeta,{hash:{},inverse:c.noop,fn:c.program(1,h,i),data:i});if(u||u===0)s+=u;s+="\n\n",u=n["if"].call(t,t.canAddMeta,{hash:{},inverse:c.noop,fn:c.program(3,p,i),data:i});if(u||u===0)s+=u;s+='\n\n<div class="person-list">\n\n',a={hash:{},inverse:c.noop,fn:c.program(5,d,i),data:i},u=(o=n.isFlipped||t.isFlipped,o?o.call(t,t.flippers,"enable-pro-badge",a):f.call(t,"isFlipped",t.flippers,"enable-pro-badge",a));if(u||u===0)s+=u;s+="\n\n",a={hash:{},inverse:c.noop,fn:c.program(11,y,i),data:i},u=(o=n.isNotFlipped||t.isNotFlipped,o?o.call(t,t.flippers,"enable-pro-badge",a):f.call(t,"isNotFlipped",t.flippers,"enable-pro-badge",a));if(u||u===0)s+=u;return s+='\n\n</div>\n\n<div style="clear:both;"></div>',s}),r={};e.Array.each(["sub-photo-person-pro-badgeable","invite-person","sub-photo-person","invite-person"],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/sub-photo-tags-people-section",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base","hermes-template-sub-photo-person-pro-badgeable","hermes-template-invite-person","hermes-template-sub-photo-person","hermes-template-invite-person"]});
YUI.add("hermes-template-photo-charm-tags-tag",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function p(e,t){return'data-tag-might-exist="true"'}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a,f=this,l="function",c=this.escapeExpression,h=n.helperMissing;s+="<li ",o=n["if"].call(t,t.mightExist,{hash:{},inverse:f.noop,fn:f.program(1,p,i),data:i});if(o||o===0)s+=o;return s+=' data-tag-id="',(o=n.escapedTagRaw)?o=o.call(t,{hash:{},data:i}):(o=t.escapedTagRaw,o=typeof o===l?o.apply(t):o),s+=c(o)+'" class="tag" data-validated="false">\n	<a class="remove-tag" href="#">x</a>\n	<a class="server-only-link" href="',a={hash:{},data:i},s+=c((o=n.getTagSearchUrl||t.getTagSearchUrl,o?o.call(t,t.tagValue,a):h.call(t,"getTagSearchUrl",t.tagValue,a)))+'" title="',(u=n.tagRaw)?u=u.call(t,{hash:{},data:i}):(u=t.tagRaw,u=typeof u===l?u.apply(t):u),s+=c(u)+'">',(u=n.tagRaw)?u=u.call(t,{hash:{},data:i}):(u=t.tagRaw,u=typeof u===l?u.apply(t):u),s+=c(u)+"</a>\n</li>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/photo-charm-tags-tag",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("sub-photo-tags-people-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){return this.photoId=t.photoId,this.context=e.clone(t.context,!0),this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this._css={locked:"ui-util-locked",working:"ui-util-working",removed:"ui-util-removed",shim:"c-contact-search-shim"},this},loadState:function(){var t=this,n=new e.FlickrPromise({photo:this.appContext.getModel("photo-models",this.photoId),photoPeople:this.appContext.getModel("photo-people-models",this.photoId),peopleModel:this.appContext.getModelRegistry("person-in-photo-models"),person:this.appContext.getModelRegistry("person-models")});return n.then(function(e){t.set("photo",e.photo),t.set("photoPeople",e.photoPeople),t.set("peopleModel",e.peopleModel),t.set("person",e.person)}).then(function(){var e=t.appContext.getViewer();if(e.signedIn)return t.get("person").get(e.nsid).then(function(e){t.set("me",e)})})},buildContainer:function(){var e,t=this.get("photo"),n=this.get("photoPeople"),r=n.getValue("people"),i=t.getValue("isOwner")||t.getValue("canAddMeta"),s,o=t.getValue("isOwner"),u=this,a=!1;return r&&(s=r.toJSON(),s.length===0&&i&&(a=!0,this.get("container").addClass("empty"),this.fire("subviewViewEvent","tagsPeopleView:peopleEmpty")),s.forEach(function(e){e.person?(e.person.size=32,e.person.showRemove=u.canRemoveTag(o,u.appContext.getViewer().nsid,e.addedBy,e.person.nsid),e.person.dataAttr={key:"person-nsid",value:e.person.nsid}):(e.invite={size:32,email:e.email},e.invite.showRemove=u.canRemoveTag(o,u.appContext.getViewer().nsid,e.addedBy,null),e.invite.dataAttr={key:"person-tag-email",value:e.invite.email})}),s=s.sort(function(e,t){return e.invite&&t.person?-1:e.person&&t.invite?1:e.person&&t.person&&e.person.displayname.toUpperCase()<t.person.displayname.toUpperCase()?-1:e.person&&t.person&&e.person.displayname.toUpperCase()>t.person.displayname.toUpperCase()?1:e.invite&&t.invite&&e.invite.email&&t.invite.email&&e.invite.email.toUpperCase()<t.invite.email.toUpperCase()?-1:e.invite&&t.invite&&e.invite.email&&t.invite.email&&e.invite.email.toUpperCase()>t.invite.email.toUpperCase()?1:0})),i||s.length>0?e=this.templates("sub-photo-tags-people-section")({people:s,canAddMeta:i,emptyPeopleTags:a,flippers:this.appContext.flipper.toJSON()}):e="",this.setContainerHTML(e),this},focusTag:function(){var e=this.get("container"),t=e.one(".add-person");t&&t.focus()},activate:function(){var t=this.get("container"),n=t.one(".add-person"),r="",i=this.get("photoPeople")?this.get("photoPeople").getValue("people"):null,s=[],o=this,u=this.appContext.getViewer().prefs.keyboardShortcutsEnabled;return t.one(".show-add-people")&&(this.registerEventHandler(t.one(".show-add-people").on("click",function(e){e.preventDefault(),t.hasClass("empty")&&(t.removeClass("empty"),o.fire("subviewViewEvent","tagsPeopleView:peopleNotEmpty")),t.one(".c-contact-search-autocomplete").setStyle("display","block"),t.one(".add-person").setStyle("display","block"),t.one(".add-person").focus()})),u&&this.attachKeyEvent("down:80",function(e){e.preventDefault();try{t.hasClass("empty")&&(t.removeClass("empty"),o.fire("subviewViewEvent","tagsPeopleView:peopleNotEmpty")),t.one(".c-contact-search-autocomplete").setStyle("display","block"),t.one(".add-person").setStyle("display","block"),t.one(".add-person").focus()}catch(n){}})),this.focus&&(setTimeout(function(){n.focus()},100),this.focus=!1),n&&(i&&(s=i.getList()),this.arrow=e.Node.create('<span class="ui-dialog-arrow contact-autocomplete-arrow"></span>'),this.contacts=new e.ContactSearchBox({el:n,appContext:this.appContext,shim:this._css.shim,elValue:"value",signedOut:!1,canTag:1,noShim:!0,searchNonContacts:!0,loadMoreOnScroll:!0,upInitially:!1,alwaysDownward:!0,loadingState:this.templates(e.Balls())(),max:1e3,hideInitially:s.map(function(e){return e.id}),me:this.get("me"),onError:function(){n.blur(),o.contacts.hide(),o.fire("subviewViewEvent","getDialogOffset",function(t){var n=e.Views.dialog.getInstance("dialog-alert",{content:o.intlMessage({intlName:"photo-page-scrappy.CONTACT_LIST_ERROR"}),attrs:{title:o.intlMessage({intlName:"common.ERROR"}),level:"warning",confirmLabel:o.intlMessage({intlName:"common.OK"})},parent:o,offsetLeft:t,dialogClass:"scrappy-dialog"});n.show()})},onShow:function(r){var i=n.ancestor(".c-contact-search-autocomplete");o.arrow||(o.arrow=e.Node.create('<span class="ui-dialog-arrow contact-autocomplete-arrow"></span>')),o.arrow.inDoc()||i.appendChild(o.arrow),o.arrow.removeClass("hide"),t.addClass(o._css.locked),o.fire("subviewViewEvent","make in view",t)},onSelect:function(e){e?t.removeClass(o._css.locked):t.addClass(o._css.locked)},onHide:function(){var e=n;o.arrow.addClass("hide"),e.setHTML(r),o.fire("subviewViewEvent","close in view")},onOrientationChange:function(e){o.arrow&&(e?o.arrow.addClass("upside-down"):o.arrow.removeClass("upside-down"))},clickContact:function(t,i){var s,u,a,f,l,c,h;if(e.UA.ie&&document.getSelection()){c=document.getSelection().anchorNode;if(c.id==="content")return}n.removeClass("focused"),n.setHTML(r),o.contacts.abort=!0,o.hideDropdown=setTimeout(function(){o.contacts.hide()},150),i?s=i.ancestor("[data-nsid]",!0):s=t.target.ancestor("[data-nsid]",!0);if(!s){o.contacts.hide();return}u=s.getData("nsid"),f=s.one("img").get("src"),a=s.getData("displayname")||"",l=s.getData("path-alias"),h=s.getData("ispro")||!1,o.addTemporaryPersonTag(a,u,f,l,h),o.addRemotePersonTag(u),o.contacts.hideFromSearch(u),o.contacts.hide(),o.contacts.abort=!0,o.get("container").one(".add-person").set("value",""),o.get("container").one(".add-person").focus()}}),this.registerEventHandler(n.on("focus",function(t){var n=this;t.preventDefault(),this.addClass("focused"),o.contacts.abort=!1,setTimeout(function(){e.UA.ie&&(n.addClass("focused"),n.focus()),n.set("text","")},40)})),this.registerEventHandler(n.on("keydown",function(e){e.keyCode===13&&(e.halt(),clearTimeout(o.hideDropdown
),n.focus())})),this.registerEventHandler(n.on("blur",function(e){this.removeClass("focused")})),this.registerEventHandler(n.ancestor(".c-contact-search-autocomplete").on("focus",function(e){e.target.hasClass("c-contact-search-autocomplete")&&(clearTimeout(o.hideDropdown),n.focus())}))),t.one(".person-list")&&this.registerEventHandler(t.one(".person-list").on("click",function(e){e.target.hasClass("remove-person")?o.removeTag(e):e.target.ancestor("[data-loading]")&&e.preventDefault()})),this},removeTag:function(t){t.preventDefault();var n=t.target.ancestor("[data-person-nsid]"),r=t.target.ancestor("[data-person-tag-email]"),i=this.get("photoPeople").getValue("people"),s,o;n?(s=n.getData("person-nsid"),n.setAttribute("data-loading",s),i.removeFromList(s,"id"),this.remoteRemoveTag(s),this.contacts.showInSearch(s)):r?(o=r.getData("person-tag-email"),r.setAttribute("data-loading",o),i.removeFromList(o,"email"),this.remoteRemoveTag(null,o)):e.Flog.warn("[photo-charm-tags-people-view] tried to remove invalid person tag.")},remoteRemoveTag:function(e,t){var n=this.get("container"),r=n.one(".person-list"),i=e?"userId":"email",s=e||t,o=this,u={photoId:this.photoId,coords:{x:0,y:0,w:0,h:0}};u[i]=s,this.get("peopleModel").remoteDelete(u).then(function(){var i=e?r.one('[data-person-nsid="'+e+'"]'):r.one('[data-person-tag-email="'+t+'"]');i&&i.remove(!0),r.one("li")||(n.one(".c-contact-search-autocomplete").setStyle("display","none"),n.addClass("empty"),o.fire("subviewViewEvent","tagsPeopleView:peopleEmpty"))},function(e){o.onError(o.intlMessage({intlName:"photo-page-scrappy.FAILED_TO_REMOVE_PERSON"}))})},addTemporaryPersonTag:function(e,t,n,r,i){this.addPerson({dataAttr:{key:"loading",value:t},buddyicon:n,size:50,displayname:e,isPro:this.appContext.flipper.isFlipped("enable-pro-badge")&&i,pathAlias:r||t,nsid:t,showRemove:!0})},addPerson:function(e){var t=this.get("container"),n=t.one(".person-list"),r,i;this.appContext.flipper.isFlipped("enable-pro-badge")?i="sub-photo-person-pro-badgeable":i="sub-photo-person",r=this.templates(i)(e),n.prepend(r)},addRemotePersonTag:function(e){var t=this.get("container"),n=t.one(".person-list"),r=this,i=this.get("photoPeople")?this.get("photoPeople").getValue("people"):null;this.get("peopleModel").remoteCreate({photoId:this.photoId,userId:e,addedBy:r.get("me").getValue("nsid"),coords:{x:0,y:0,w:0,h:0}}).then(function(t){var s,o,u=n.one('[data-loading="'+e+'"]');u&&(u.removeAttribute("data-loading"),u.setAttribute("data-person-nsid",e)),s=r.get("peopleModel"),o=s.add(t),i&&i.appendToList(o)},function(){var t=n.one('[data-loading="'+e+'"]');t.remove(!0),r.onError(r.intlMessage({intlName:"photo-page-scrappy.PERSON_CANNOT_BE_TAGGED"}))})},canRemoveTag:function(e,t,n,r){return e||t&&n===t||r&&r===t},onError:function(t){var n=this,r;r=new e.Views.FluidModal({appContext:this.appContext,title:n.intlMessage({intlName:"common.ERROR"}),message:t,actionButtonLabel:n.intlMessage({intlName:"common.OK"}),showCancelButton:!1}),r.show()}})},"@VERSION@",{requires:["flickr-view","flog","dialog","hermes-template-sub-photo-person-pro-badgeable","hermes-template-sub-photo-person","hermes-template-invite-person","hermes-template-creatr-footer","hermes-template-sub-photo-tags-people-section","hermes-template-photo-charm-tags-tag","photo-charms-tags-people-section-css","url-helper","contact-search-box","html5-balls"],optional:[],langBundles:["common","photo-page-scrappy"]});
